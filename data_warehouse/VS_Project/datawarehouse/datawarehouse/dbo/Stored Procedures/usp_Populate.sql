




CREATE proc [dbo].[usp_Populate]
as


--*************************************************************************************************
--*************************************************************************************************
--*************************************************************************************************
exec [dbo].[usp_DropFK_DropIdx_TruncateAll]


--*************************************************************************************************
--*************************************************************************************************
--*************************************************************************************************
insert dbo.Tally(N)
select top(100000)
	cast(row_number() over(order by a.id) as int)
from
	master.dbo.syscolumns a
	cross join master.dbo.syscolumns b


--*************************************************************************************************
--*************************************************************************************************
--*************************************************************************************************
insert [dbo].dimEncounter([EncounterID], [AdmissionType], [EncounterType])
values('E001', 'ER', 'Chest Pains'),
('E002', 'GENERAL', 'Cough'),
('E003', 'ER', 'Stroke'),
('E004', 'GENERAL', 'Burn')


--*************************************************************************************************
--*************************************************************************************************
--*************************************************************************************************
insert [dbo].[dimPatient]([PatientID], [Gender])
values('john', 'm'),
('carlos', 'm'),
('mary', 'f'),
('jane', 'f')


--*************************************************************************************************
--*************************************************************************************************
--*************************************************************************************************
insert [dbo].dimEncounter([EncounterID], [AdmissionType], [EncounterType])
values('E001', 'ER', 'Chest Pains'),
('E002', 'GENERAL', 'Cough'),
('E003', 'ER', 'Stroke'),
('E004', 'GENERAL', 'Burn')


--*************************************************************************************************
--*************************************************************************************************
--*************************************************************************************************
;with cte
as
(
	select
		dateadd(d, t.N-1, '1/1/2017') dd
	from
		dbo.Tally t
	where
		t.N between 1 and 1000
)
insert [dbo].dimDate([dimDateKey], [altdate], [Year], [Quarter], [Month], [Day])
select
	year(cte.dd) * 10000 + month(cte.dd) * 100 + day(cte.dd) as [dimDateKey]
	,cte.dd as [altdate]
	,year(cte.dd) as [Year]
	,datepart(quarter, cte.dd) as [Quarter]
	,month(cte.dd) as [Month]
	,day(cte.dd) as [Day]
from	
	cte


--*************************************************************************************************
--*************************************************************************************************
--*************************************************************************************************
insert into [dbo].[factEncounter]([dimEncounterKey], [dimDateKey_Admission], [dimDateKey_Discharge], [dimPatientKey], [Cost])
select
	e.[dimEncounterKey]
	,da.dimDateKey
	,dd.dimDateKey
	,p.dimPatientKey
	,ABS(CHECKSUM(NewId())) % 1000
from
	dbo.dimEncounter e
	cross join dbo.dimPatient p
	cross join dbo.dimDate da
	cross join dbo.dimDate dd
where
	da.dimDateKey <= dd.dimDateKey
union all
select
	e.[dimEncounterKey]
	,da.dimDateKey
	,da.dimDateKey
	,p.dimPatientKey
	,ABS(CHECKSUM(NewId())) % 1000
from
	dbo.dimEncounter e
	cross join dbo.dimPatient p
	cross join dbo.dimDate da
where
	da.Month between 1 and 2


--*************************************************************************************************
--*************************************************************************************************
--*************************************************************************************************
exec [dbo].[usp_AutomaticallyCreateForeignKeyRelationships]


--*************************************************************************************************
--*************************************************************************************************
--*************************************************************************************************
exec sp_MSforeachtable 'select ''?'', count(*) from ?'

